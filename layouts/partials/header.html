<header class="site-header">
  <div class="header-container header-inner">
    <a class="site-logo" href="/">
      {{ with .Site.Params.logo }}
        <img src="{{ . | relURL }}" alt="{{ $.Site.Title }}">
      {{ else }}
        {{ .Site.Title }}
      {{ end }}
    </a>

    <button class="nav-toggle" type="button" aria-expanded="false" aria-controls="main-nav">
      <span class="sr-only">Menú</span>
      <span class="nav-toggle-bar"></span>
      <span class="nav-toggle-bar"></span>
      <span class="nav-toggle-bar"></span>
    </button>

    <nav class="main-nav" id="main-nav" aria-label="Navegación principal">
      <ul class="main-nav-list">
        {{ range .Site.Menus.main }}
          {{ if .Children }}
            {{ $menuId := printf "nav-%s" (.Identifier | default (urlize .Name)) }}
            <li class="nav-item nav-item--dropdown">
              <button class="nav-link nav-button" type="button" data-nav-toggle aria-expanded="false" aria-controls="{{ $menuId }}">
                {{ .Name }}
              </button>
              <div class="nav-dropdown" id="{{ $menuId }}" data-nav-menu hidden>
                {{ range .Children }}
                  <a class="nav-dropdown-link" href="{{ .URL | relLangURL }}">{{ .Name }}</a>
                {{ end }}
              </div>
            </li>
          {{ else }}
            <li class="nav-item">
              <a class="nav-link" href="{{ .URL | relLangURL }}">{{ .Name }}</a>
            </li>
          {{ end }}
        {{ end }}
        <li class="nav-item nav-item--lang">
          <div class="lang-toggle" role="group" aria-label="{{ i18n "language_toggle" }}">
            {{ $current := . }}
            {{ $translations := .Translations }}
            {{ $tkey := $current.Params.translationKey }}
            {{ range .Sites }}
              {{ $target := .Home }}
              {{ if $current.IsTranslated }}
                {{ $matches := where $translations "Lang" .Language.Lang }}
                {{ if gt (len $matches) 0 }}
                  {{ $target = index $matches 0 }}
                {{ end }}
              {{ end }}
              {{ if and (not $current.IsTranslated) $tkey }}
                {{ $candidates := where .AllPages "Params.translationKey" $tkey }}
                {{ $langMatches := where $candidates "Lang" .Language.Lang }}
                {{ if gt (len $langMatches) 0 }}
                  {{ $target = index $langMatches 0 }}
                {{ end }}
              {{ end }}
              {{ if eq .Language.Lang $current.Language.Lang }}
                <span class="lang-toggle-item lang-toggle-item--active">{{ upper .Language.Lang }}</span>
              {{ else }}
                <a class="lang-toggle-item" href="{{ $target.RelPermalink }}">{{ upper .Language.Lang }}</a>
              {{ end }}
            {{ end }}
          </div>
        </li>
      </ul>
    </nav>
  </div>
</header>

<script>
  (() => {
    const toggles = document.querySelectorAll('[data-nav-toggle]');
    const menus = document.querySelectorAll('[data-nav-menu]');
    const navToggle = document.querySelector('.nav-toggle');
    const nav = document.querySelector('#main-nav');
    if (!toggles.length || !menus.length) return;

    const closeAllMenus = () => {
      menus.forEach((menu) => {
        menu.hidden = true;
      });
      toggles.forEach((toggle) => {
        toggle.setAttribute('aria-expanded', 'false');
      });
    };

    const openMenu = (toggle) => {
      const menuId = toggle.getAttribute('aria-controls');
      const menu = document.getElementById(menuId);
      if (!menu) return;
      closeAllMenus();
      menu.hidden = false;
      toggle.setAttribute('aria-expanded', 'true');
    };

    toggles.forEach((toggle) => {
      toggle.addEventListener('click', () => {
        const isOpen = toggle.getAttribute('aria-expanded') === 'true';
        if (isOpen) {
          closeAllMenus();
        } else {
          openMenu(toggle);
        }
      });
    });

    navToggle?.addEventListener('click', () => {
      const isOpen = navToggle.getAttribute('aria-expanded') === 'true';
      navToggle.setAttribute('aria-expanded', String(!isOpen));
      nav?.classList.toggle('main-nav--open', !isOpen);
    });

    document.addEventListener('click', (event) => {
      const clickedInsideMenu = Array.from(menus).some((menu) => menu.contains(event.target));
      const clickedToggle = Array.from(toggles).some((toggle) => toggle.contains(event.target));
      if (!clickedInsideMenu && !clickedToggle) {
        closeAllMenus();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeAllMenus();
      }
    });
  })();
</script>
